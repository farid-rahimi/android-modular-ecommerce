package com.solutionium.core.ui.common.component

import androidx.compose.animation.core.copy
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.width
import androidx.compose.material3.LocalTextStyle
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.SpanStyle
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.buildAnnotatedString
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextDecoration
import androidx.compose.ui.text.withStyle
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.unit.times
import java.text.NumberFormat
import java.util.Locale

@Composable
fun PriceView(
    price: Double,
    onSale: Boolean = false,
    regularPrice: Double? = null,
    magnifier: Double = 1.0
) {
    Row(verticalAlignment = Alignment.CenterVertically) {
        FormattedPriceV2(price.toLong(), magnifier = magnifier)

        if (onSale && regularPrice != null) {
            Spacer(modifier = Modifier.width(4.dp))
            FormattedPriceV2(
                regularPrice.toLong(),
                currency = "",
                mainStyle = TextStyle(fontSize = magnifier * 12.sp, fontWeight = FontWeight.Normal, color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f), textDecoration = TextDecoration.LineThrough)

            )
        }
    }
}

@Composable
fun FormattedPriceV2(
    amount: Long,
    currency: String = "Øª",
    modifier: Modifier = Modifier,
    locale: Locale = Locale.getDefault(),
    magnifier: Double = 1.0,
    mainStyle: TextStyle = TextStyle(fontSize = magnifier*16.sp, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.onSurface),
    currencySymbolStyle:  SpanStyle = SpanStyle(
        fontSize = mainStyle.fontSize * 0.8f,
        fontWeight = mainStyle.fontWeight,
        color = mainStyle.color
    ),
    smallDigitsSpanStyle: SpanStyle = SpanStyle(
        fontSize = mainStyle.fontSize * 0.70f,
        fontWeight = mainStyle.fontWeight,
        color = mainStyle.color,
        textDecoration = mainStyle.textDecoration
    )
) {
    //val currency = remember(currencyCode) { Currency.getInstance(currencyCode) }
    //val currencySymbol = remember(currency, locale) { currency.getSymbol(locale) }

    val numberString = amount.toString()

    val numberFormat = remember(locale) {
        NumberFormat.getNumberInstance(locale).apply {
            isGroupingUsed = true
            maximumFractionDigits = 0
            minimumFractionDigits = 0
        }
    }

    val annotatedString = buildAnnotatedString {


        if (numberString.length > 3) {
            val mainPartValue = numberString.substring(0, numberString.length - 3).toLongOrNull() ?: 0L
            val smallPartValue = numberString.substring(numberString.length - 3)
            val formattedMainPart = numberFormat.format(mainPartValue)

            withStyle(style = mainStyle.toSpanStyle()) {
                append(formattedMainPart)
            }

            withStyle(style = smallDigitsSpanStyle) {
                append(",")
                append(smallPartValue)
            }
        } else { // Amount is 0-999
            // Format the whole number with main style, but then re-apply small style to the available digits
            val formattedFullNumber = numberFormat.format(amount) // e.g. "123" or "0"

            val wholeFormatted = numberFormat.format(amount) // e.g. for 123 -> "123", for 0 -> "0"

            if (amount == 0L) { // Special case for exactly 0
                withStyle(style = mainStyle.toSpanStyle()){ append("0") }
            } else {
                // For numbers 1-999, make the entire number small as per "last 3 digits smaller"
                // if it's all within those 3 digits.
                withStyle(style = smallDigitsSpanStyle) {
                    append(numberString) // Use original non-formatted number to avoid issues with separators
                }
            }
        }
        append("\u00A0") // Non-breaking space
        withStyle(style = currencySymbolStyle) {
            append(currency)
        }

    }

    Text(text = annotatedString, modifier = modifier) // The mainStyle is implicitly the default for non-styled parts
}
